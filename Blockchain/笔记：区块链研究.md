[TOC]

# 综述

## 思考与提问

> 通过提问与解答，主动探寻未知；针对比较有代表性的提问，可以整理成单独的章节，放到思考与提问之后。

**问题**：

我们希望普通用户可以方便地参与到联盟链中去，重点考察FISCO BCOS中普通用户是否容易作为观察节点或者客户端加入联盟链当中，需不需要像它说的去做IP配置，需不需要审核后才能加入，如果用户很难参与到这个联盟链，那就不符合我们的场景，更可能会使用Hyperledger Fabric。

**回答**：

FISCO-BCOS的节点分为两种：创世节点（一条链中有且只有一个）和普通节点。创世节点上维护运行着系统合约（一条链只有一个系统合约，内置的智能合约，用来对整个网络进行管理操作，原则上只允许管理员账号调用），普通节点通过系统代理合约（系统合约的统一入口）调用系统合约（需要相应的外部账户权限，==但具体的外部账户在节点管理中的作用和关系还不清楚==）。整个网络的路由被记录在节点中的连接文件`bootstrapnodes.json`中（通过系统合约中的全网配置合约管理，每个节点中都需要维护一个`bootstrapnodes.json`）。

在网络构建的过程中，要首先构建创世节点，配置系统合约的各项参数，然后创建普通节点。当节点配置好、启动后，还要注册到系统合约记账节点列表中，才能够参与记账。这里，通过系统合约中的节点管理合约（`systemcontract/NodeAction.sol`）来进行节点的加入和退出管理。因为在节点注册和退出的过程中，都要求节点是启动的，所以我们理论上可以做到动态的节点管理，具体需要试验验证。

FISCO-BCOS还提供了一套面向CA的准入机制，一条链维护着一个链证书和私钥，对每个参与该链的机构签发机构证书，机构对下属节点签发节点证书，节点通过节点证书与其他节点之间建立SSL连接。FISCO-BCOS提供了证书注销机制（`CAAction`），区块链的管理者通过登记证书到注销证书列表，来禁止使用该证书的节点接入网络。

针对不同用户的权限问题，FISCO-BCOS提供了系统合约中的权限管理合约进行权限管理。基本的权限模型是一个外部账户只属于一个角色，一个角色拥有一个权限项列表，一个权限项列表由合约地址加合约接口来唯一标识。这意味着，角色和对应的权限是高度可定制的，这意味着我们应该可以做到让不同的用户依据自身的权限灵活方便地参与到联盟链中去。

具体的我准备看完文档，做个试验，我还有很多东西不太理解，具体的笔记我记在纸上了，明天我会整理成电子版和你分享。

**问题**：

我们需要进一步研究的重点包括：1，这个联盟链当中可不可以实现任意一个高权限节点直接进行记账？ 2，指定其中某类合约，可以让任意用户不经复杂配置参与到链中，能够查询和校验数据

**回答**：

权限是和外部账户挂钩的，权限直接对应到某个智能合约的某个接口，所以我们可以通过角色和权限的精确设定，控制哪些账户执行哪些功能。而且角色和权限的设定是我们在开发阶段做好的，对于外部用户来说，这一切对它们是透明的，他们不需要自己配置，也不允许他们自己配置。

FISCO-BCOS引入了出块节点注册机制：在系统合约里提供了管理记账节点的工具，仅将节点注册到记账者列表，节点才可作为leader出块；若节点不可信，可调用该工具将其从记账者列表中移除。

一个用户想使用某个节点出块（记账），一方面要看他有没有出块的权限，另一方面要看他登陆的这个节点有没有出块注册。

**问题**：

第一个需求就是：有多个具有官方背景的机构，他们之间已经实现了相互信任，对于某些业务类型来说，只要这里面的任意一个机构发起记账操作，都可以得到大家信任。

**回答**：

**问题**：

**回答**：

## 公有链、私有链、联盟链、许可链的区别

主要从读写权限和交易权限上去划分：

**公有链**

公有链是指全世界任何人都可以随时进入系统中读取数据、发送可确认交易、竞争记账的区块链。公有链通常被认为是完全去中心化的，因为没有任何人或机构可以控制或者篡改其中数据的读写。

公有链一般会通过代币机制鼓励参与者竞争记账，来确保数据的安全性。比特币、以太币都是典型的公有链。

主要特点：用户免受开发者影响、所有数据默认公开、访问门槛低。

**私有链**

私有链是指其写入权限是由某个组织和机构控制的区块链。参与节点的资格会被严格的限制，由于参与的节点是有限和可控的，因此私有链往往可以有极快的交易速度、更好的隐私保护、更低的交易成本、不容易被恶意攻击、并且能够做到身份认证等金融行业必须的要求。

相比中心化数据库，私有链能够防止机构内单节点故意隐瞒或篡改数据。即使发生错误，也能够很快就发现来源，因此许多大型金融企业更倾向于使用私有链技术。

主要特点：给隐私更好的保障、交易成本大幅度降低、交易速度非常之快。

**联盟链**

联盟链是指由若干个机构共同参与管理的区块链，每个机构都运行着一个或多个节点，其中的数据只允许系统内不同的机构进行读写和发送交易，并且共同来记录交易数据。

私有链和联盟链之间的设计隐私权限会有不同，联盟链中的权限设计要求往往会更加复杂。

**许可链**

许可链是指参与到区块链系统中的每个节点都是经过许可的。未经许可的节点是不可接入系统中。因此，私有链和联盟链都属于许可链。

需要注意的是，有些许可链没有代币机制，因为不需要代币来鼓励节点竞争记账。

参考：

- [公司该如何创建适合自己的区块链产品、联盟链、私链](https://blog.csdn.net/tianyaleixiaowu/article/details/79309410)
- [联盟链战国：五大巨头横向对比](https://www.8btc.com/article/293025)
- [起“底”联盟链：FISCO BCOS 与 Fabric 之较](https://www.infoq.cn/article/2018%2F09%2Funcover-consortium-blockchain)

## 区块链基础架构模型

区块链：“去中心”不是目的，“可信”才是。

区块链的共识机制：一致性协议（PoW、PoS、PoA）



## 关于区块链的存储机制

- 如何将数据写入区块？
- 如何查询区块链中的数据？
- 区块中能够写入多少数据？
- 区块链中数据的组织形式如何？
- 交易是存储在区块上的，交易的地址对应着交易在区块链上的存储位置，可以这样理解吗？那么账户的数据存储在哪里？账户的地址代表什么？

**区块链本质上是全局共享的分布式账本**，我的理解如下：

- **全局共享**：所有用户都能够查看全量数据
- **分布式**：所有节点都可以维持一个全量数据
- **账本**：日志，如交易日志、状态日志等，它不同于传统数据库的键值对，它记录的就是信息，但会利用HASH树或字典树等数据结构来组织这些信息，便于查找。

BCOS/FISCO-BCOS是基于Ethereum深度定制开发的，所以在存储机制上和Ethereum的存储机制基本一致。

参考：

- [浅谈Ethereum的存储](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%85%E8%B0%88Ethereum%E7%9A%84%E5%AD%98%E5%82%A8) 
- 《区块链技术指南》 2.1.1 1.数据区块 这里讲的是比特币的数据区块结构
- [深入了解以太坊：数据到底是如何存储在以太坊网络的？](https://baijiahao.baidu.com/s?id=1608490460450421948&wfr=spider&for=pc)
- 

比特币的区块中存储的是交易信息，如下所示比特币的区块链结构：

![Capture](C861BBA182784A8E8E3D8D5177A60317)

比特币的账户余额使用**UTXO模型**实现的（UTXO，未花费的交易输出，根据交易的定义，除特殊交易外，如比特币挖矿奖励交易，一个交易的输入必是上一个交易的输出，一个交易的输出如果已经用于一个交易的输入了，就不能再给另一个交易使用了，于是，比特币利用UTXO模型就可以维护账户余额了，即当前账户所拥有的未花费的交易输出就是它的余额）

以太坊是一个基于交易的状态机器，如下图所示是以太坊的区块链结构：

![u=4046573801,937947329&fm=173&app=25&f=JPEG](8A2A105704074A22B8CD01F4967C2F4D)

以太坊用**账户模型**来维护账户状态（各种state variable），账户状态实际上属于**暂时数据**，是可以变动的。以太坊中另一种数据类型是**永久数据**，例如交易，一旦交易确认，就会在区块链中记录；然后就再也不可以更改。

如上图所示，交易数据被存储在**Transaction Trie**（**字典树**，查询效率比HASH树高）中，账户状态被存储在**State Trie**中，智能合约被存储在**Storage Trie**中，Storage Trie的根存储在State Trie中。

# 参考资料

> 所有的参考资料放在这里，给出摘要、总结或感悟。

- 文章：[区块链发展过程的六个阶段 让你完整了解区块链历史](http://www.ittime.com.cn/news/news_19671.shtml)
- 文章：[区块链分享医疗数据：AI学者提出新型匿名数据收集方式](http://note.youdao.com/noteshare?id=eacdfc651285837f9d25ced46d404552&sub=30AFD4D56BE7418C9463791D6EA304E7)
- 文章：[如何成为一名区块链工程师？ | 附学习资源](http://note.youdao.com/noteshare?id=1968be0be3de5781f7b72b10c2583df4&sub=1FC4682EBCA541E7AC20681B8B426FC3)
- 文章：[资料 | 区域链相关资料汇总(1)](http://note.youdao.com/noteshare?id=822f50e0424db3118700998526b51eb9&sub=F7626A08F66946F8BE60CA0FEE1E62BC)
- 文章：[什么是区块链？ 区块链的入门教程~](http://note.youdao.com/noteshare?id=1a220b5e393ad159ccd8999e6a6b3986&sub=979FB5DD56BF46A6BF34917E8DB751C1)

## 文档：[2018 年中国区块链产业白皮书](http://xxzx.miit.gov.cn/n602427/c593017/part/593018.pdf)

摘要：

https://www.jianshu.com/p/6ac84516a4c5

## 文章：[区块链技术的发展历史](https://baijiahao.baidu.com/s?id=1595600496755912857&wfr=spider&for=pc)

**摘要**：

一些基本概念阐述：存储数据的数据区块及其之上的数字签名、时间戳等技术，有作为支撑的P2P网络和维护系统的共识算法，有挖矿和工作量证明机制，有匿名交易机制和比特币钱包，还有链龄、UTXO、Merkle树、双花等相关技术概念介绍。

框架与特点：

1. 框架简介：从网络层、数据层、应用层三个层面介绍了区块链的基础架构。
2. 架构特点: 介绍了区块链的去中心化、可靠数据库、开源可编程、集体维护、安全可信、交易准匿名性等特点。如果一个系统不具有以上特征，将不能被视为基于区块链技术的应用。

区块链运作的核心技术：区块链的链接、共识机制、解锁脚本、交易规则、交易优先级、Merkle证明、RLP

区块链交易流程：以比特币的交易为例，介绍了交易的生成、交易的传播、工作量证明、整个网络节点验证、记录到区块链等流程。


## 文章：[区块链：什么是第三代平台？它们能提供哪些以太坊目前没有的服务？ - 简书](http://note.youdao.com/noteshare?id=d2e359e25b26842b745dfa81f7208c6e&sub=wcp1546390342382436)

**摘要**：

区块链应用的三个关键属性：可扩展性、互操作性和整体易用性。

可扩展性是区块链在链中容纳尽可能多的用户的能力，同时仍然保持低交易费用和达成共识的效率。区块链最重要的任务是达到一定程度的可扩展性，从而可以实现区块链技术的首次大规模应用。

互操作性是区块链协议的一种能力，在具有互操作性能力的协议下，不同区块链之间能进行交互和协作，而协议与协议之间能达成智能合约。互操作性的本质是消除对中间人（集中化的代表）的需求，提高性能和可扩展性，以及连接私有和公共的区块链。

易用性的终极目标是：终端用户甚至不知道他们正在使用区块链。总而言之，对开发人员和用户友好的区块链就是易用的。（==注意，诸如EOS项目付费的问题==）

一些区块链3.0的项目：[NEO](https://neo.org/), [EOS](https://eos.io/), [MatrixChain](https://www.matrix.io/), [Zilliqa](https://zilliqa.com/), Qtum，ICON，Nebulas，Elastos，Ontology.

单个区块链无法满足现实世界的各种需求场景，还是应当专注于具体的应用场景，开发专业地可以满足具体需求的区块链产品。这个生态系统将继续增长和专业化，这是未来的趋势。

## 文章：[[区块链概述---如何简单的理解区块链技术]](https://www.cnblogs.com/zhuweiheng/p/8206188.html)

区块链技术被认为是继蒸汽机、电力、互联网之后，下一代颠覆性的核心技术。 如果说蒸汽机释放了人们的生产力，电力解决了人们基本的生活需求，互联网彻底改变了信息传递的方式，那么区块链作为构造信任的机器，将可能彻底改变整个人类社会价值传递的方式。

以前是靠信誉、靠百年老店、权威机构等，区块链利用技术建立了新的信任方式，这是可以被量化的，从技术的角度实现的，所以说区块链成为了下一个信任的基石。区块链最核心的革命特性是改变千百年来落后的信用机制。

 **区块链的本质是一个分布式的公共账本**，任何人都可对这个账本进行核查，但不存在单一的用户可以对它控制。在区块链系统中的参与者共同维持账本的更新：**它只能按照严格的规则和共识进行修改**。

**区块链具有多方共识，交易溯源，不可篡改等技术特点**，使它在确保信息可信、安全、可追溯等方面具有传统技术不可比拟的优势。

从技术角度简单理解区块链：

**（1）区块链的本质**

**区块链**是一种特殊的**分布式数据库**。

首先，区块链的主要作用是储存信息。任何需要保存的信息，都可以写入区块链，也可以从里面读取，所以它是数据库。

其次，任何人都可以架设服务器，加入区块链网络，成为一个节点。区块链的世界里面，没有中心节点(去中心化)，每个节点都是平等的，都保存着整个数据库。你可以向任何一个节点，写入/读取数据，因为所有节点最后都会同步，保证区块链一致。

![image](https://images2017.cnblogs.com/blog/1307828/201801/1307828-20180105181805409-1339968340.jpg)

**（2） 区块链的最大特点**

**区块链没有管理员，它是彻底无中心的**。其他的数据库都有管理员，但是区块链没有。如果有人想对区块链添加审核，也实现不了，因为它的设计目标就是防止出现居于中心地位的管理当局。

没有了管理员，人人都可以往里面写入数据，怎么才能保证数据是可信的呢，这就是区块链奇妙的地方。

**（3）区块**

区块链由一个个相连的区块（block）组成。区块很像数据库的记录，每次写入数据，就是创建一个区块。

每个区块包含两个部分：

- **区块头（Head）**：记录当前区块的元信息
- **区块体（Body）**：实际数据

![image](https://images2017.cnblogs.com/blog/1307828/201801/1307828-20180105181806143-865231136.png)

区块头包含了当前区块的多项元信息

- 生成时间
- 实际数据（即区块体）的 Hash
- 上一个区块的 Hash
- ......(不同的区块链系统会包含不同的信息)

>  Hash 就是计算机可以对任意内容，计算出一个长度相同的特征值。区块链的 Hash 长度是256位，不管原始内容是什么，最后都会计算出一个256位的二进制数字。而且可以保证，只要原始内容不同，对应的 Hash 一定是不同的。

> 举例来说，字符串123的 Hash 是a8fdc205a9f19cc1c7507a60c4f01b13d11d7fd0（十六进制），转成二进制就是256位，而且只有123能得到这个 Hash。

![1307828-20180105181806799-68077686](https://images2017.cnblogs.com/blog/1307828/201801/1307828-20180105181806799-68077686.png)

**（4）Hash 的不可修改性**

区块与 Hash 是一一对应的，每个区块的 Hash 都是针对”区块头”（Head）计算的。

Hash = SHA256(区块头)

区块头包含很多内容(包括上一个区块的Hash、当前区块体的Hash等，见上图)。这意味着，如果当前区块的内容变了，或者上一个区块的 Hash 变了，一定会引起当前区块的 Hash 改变。

如果有人修改了一个区块，该区块的 Hash 就变了。为了让后面的区块还能连到它，必须同时修改后面所有的区块，否则被改掉的区块就脱离区块链了。Hash 的计算很耗时，同时修改多个区块几乎不可能发生，除非有人掌握了全网51%以上的计算能力。

正是通过这种**联动机制**，区块链保证了自身的可靠性，数据一旦写入，就无法被篡改。这就像历史一样，**发生了就是发生了，从此再无法改变**。

![1307828-20180105181807424-321893909](https://images2017.cnblogs.com/blog/1307828/201801/1307828-20180105181807424-321893909.png)

## 文章：[公司该如何创建适合自己的区块链产品、联盟链、私链](https://blog.csdn.net/tianyaleixiaowu/article/details/79309410)

区块链技术的三个主要部分：**区块链本身**、**点对点网络**（p2p）和**共识机制**。

区块链只是数据结构化的一种方式。区块链是分类账：记录账务记录的文件。

如果把区块链比作一本永远不会完的书，每一个区块就像书的每一页，时间戳对应着页码，新区块总加在具有最新时间戳的区块之后；区块链引入密码学机制确保区块无法被篡改（**防篡改机制？**）

**冲突解决机制？**

**交易**：可以抽象成消息传递，整个传递过程包含发送者、接收者和传递内容。传递内容可以是代币数量，也可以是一段信息（代币转账数量可以看作是一段信息）。交易中还可以包含二进制数据（payload），如果交易的接收者账户中包含代码，那么交易中携带的payload就会被当作接收者账户中代码的输入数据。

**Ethereum中的两种账户**：外部账户（代币数量，that are controlled by public-private key pairs (i.e. humans) ）、智能账户（状态和代码，which are controlled by the code stored together with the account。其实正常账户也可以看作是没有代码的之智能账户，它所拥有的代币数量就是账户的状态。每当收到相应消息时，这些代码就会被执行，从而改变其状态。这些账户就是智能合约的载体）。账户由账户地址唯一标识，无论是正常账户还是智能账户，它们共享同一个地址空间。

想要了解智能合约是怎么执行的，先要了解EVM：

**EVM以太坊虚拟机**：运行时环境，用来运行智能账户收到消息时对应的代码。这个环境包含了一些内置变量，比如当前Block的Number，消息来源的地址等，还会提供一些API，一个stack供智能合约执行时使用。通过EVM运行代码后，智能账户的状态发生了变化，节点会将这些状态的变化加密生成新的Block，链接到全网账户上。注意，EVM不仅是沙箱，而且实际上是完全隔离的，这意味着在EVM内部运行的代码无法访问网络，文件系统或其他进程。 智能合约甚至可以限制其他智能合约的使用。

**智能合约举例说明**：

假设我们想向全网用户发起募捐，那就先可以定义一个智能账户，它有三个状态：当前募捐总量，捐款目标和被捐赠人的地址，然后给它定义两个函数：

接收募捐函数

接收募捐函数每次收到发过来的转账请求，先核对下发送者是否有足够多的钱（EVM会提供发送请求者的地址，程序可以通过地址获取到该人当前的区块链财务状况。）然后每次募捐函数调用时，都会比较下当前募捐总量跟捐款目标的比较，如果超过目标，就把当前收到的捐款全部发送到指定的被捐款人地址，否则的话，就只更新当前募捐总量状态值。

捐款函数

将所有捐款发送到保存的被捐赠人地址，并且将当前捐款总量清零。

每一个想要募捐的人，用自己的eth地址向该智能账户发起一笔转账，并且指明了要调用接受其募捐函数。

于是我们就有一个募捐智能合约啦，人们可以往里面捐款，达到限额后钱会自动发送到指定账户，全世界的矿工都在为这个合约进行计算和担保，不再需要人去盯着看有没有被挪用，这就是智能合约的魅力所在。

## 文章：[联盟链的权限体系](https://github.com/FISCO-BCOS/Wiki/tree/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E6%9D%83%E9%99%90%E4%BD%93%E7%B3%BB)

**摘要**：

联盟链是面向企业的，权限分级管理是基本要求。

在支持智能合约的区块链平台里，可以控制某个用户以下行为:

- 能否部署某个合约
- 能否调用某个合约（的某个接口）

角色和权限是强场景相关的，需要在搞清系统的**5W1H**的基础上进行角色和权限的规划。

- WHO ： 都会有哪些人来使用系统，如普通用户、柜员、收单机构、发卡机构、清算机构、监管者等；
- WHY ： 每个人来这个系统的目的是什么。如用户就是为了消费，柜员服务于用户，监管检视数据和进行必要的控制，机构开展业务的同时要维护系统稳定；
- WHAT： 每个人都会操作什么系统、资产、工具。如用户要用APP,看余额、要花钱、要提现，机构要有管理工具、运维工具、要开发和发布执行交易的智能合约、要清结算拿到钱款，监管机构要有大数据平台、报表或者监管工具；
- WHEN： 这些人什么时候会有一些动作。比如用户每天都会消费，机构的运维人员会定期升级和维护程序，不定期处理告警，清算机构在场切日切后要做清算，监管者可以选择是否实时介入交易，或者仅定期巡检，或在有问题时强势介入；
- WHERE： 活动场合或场所。用户通过APP随时随地在合作商户消费，APP通过机构提供的接口来发送交易，程序员在开发网开发编译，运维在IDC或ECC直接对区块链进行发布和调整，运营配置人员通过管理台或者管理工具直接或者通过远程接口进行运营数据的配置，监管机构远程调控，通过接口或者发个邮件过来指定控制措施；
- HOW：根据以上的5W，要梳理出都有哪些控制点、功能接口、管理流程，在每个场景，怎么一步一步的，通过什么工具什么操作指令，或者设定哪些联机检查规则去做到权限控制。形成详细设计，理清是否有技术或者其他障碍，然后分配到各模块去进行开发、部署。

一个账号只对应一个角色，**避免既做运动员，又做裁判员**。

- 角色拥有多个权限的集合。
- 一个帐号只能对应到一个角色。
- 一个权限对应到某智能合约的一个接口。
- 帐号只能调用被授权过的智能合约的一个到多个接口。

目前抽象出来的权限控制能力有两种模型：

- **系统级权限模型**：一个角色是否能部署新合约，是否能发起对已有合约的调用，属于系统权限模型。在该角色发起请求后和部署合约或调用合约之前，系统进行判断和控制，拒绝越权的操作。
- **接口权限模型**：作为支持智能合约的区块链平台，平台的诸多功能都是通过智能合约实现的，包括系统配置、权限配置、业务交易等、接口权限模型实现了针对智能合约接口级别的权限控制。当一个新的合约部署生效后，管理员可赋予某个角色调用该合约部分或全部接口的权限。

## 文章：[漫谈共识机制](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%BC%AB%E8%B0%88%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6)

**摘要**：

无共识，不区块链。

区块链作为一个分布式系统，可以由不同的人或机构，将安装了区块链软件的计算机（简称节点）加入到网络里，然后共同计算数据、共同见证交易的执行过程，并确认最终计算结果。

如何协同这些松散耦合，互不信任的节点一起工作，达成信任关系，并保障一致性，持续性，可以抽象为“共识”过程。

**共识需要解决的几个核心问题**是：

- 谁在这个网络里有记账权，也就是做为leader发起一次记账。
- 做为互相不信任的参与者，为什么要采纳和相信某一个人给出的记账。
- 怎么保证大家最终收到的结果都是一致的，无错的。（包括竞争和分叉处理）

代币激励在联盟链里并不是必须的。

详细介绍了**公有链**里常用的PoW工作量证明策略、PoS权益证明策略、DPoS股份授权证明策略（**都是追求“最终一致性”，而不是强一致性**，即每次记账可以理解成一次提案，大家暂时保存这一次提案的竞争结果，最终确定下来可能要依赖多次竞争，也就是所谓的一顿烧烤解决不了的问题，那就再来一顿，然后再一顿。这里会发生分叉和回滚。），和**联盟链**里的PBFT实用拜占庭容错算法、Raft算法（**追求强一致性**，也就是说一笔交易发生了，就不能再被分叉或回滚推翻了，因为联盟链里参与记账的人，身份是可知的、可控的，可能有监管或者经济共同利益之类的措施来约束他们）：

- POW：用尽创世纪时代的洪荒之力求生存求发展。
- PoS：采用权益加权，减少计算资源消耗。
- DPoS：一定程度的民选制度，用民意取代集中的权益，民意代表们把握话语权。
- PBFT：少数服从多数，快速达成共识，体现参与度和民主性，有较强的确定性和抗欺诈性。
- Raft：强调可用性和最终一致性，效率较高，不强调抗欺诈性。

BCOS中实现了可动态配置式的记账者列表，只有节点加入了记账者列表，才能够成为共识节点，参与记账。不能参与记账的节点被称为观察节点。

PBFT算法的过程是**一次提案，几步提交**，在这个过程中有复杂的状态机维护的细节。起始时可按一些简单的规则，如轮次机制，让某一个机构的某一个节点在某个区块高度上，成为议长（leader），得到记账权，然后进行记账提案，其他节点对提案进行数据验证（验证签名，验证交易数据，验证合约计算结果等），觉得都ok之后，返回一个签名确认，议长收集大家的签名，达到一定的数量后，认为达成少数服从多数的效果，则将记账结果广播出去，大家在将记账结果存下来之前，还可以再进行一次投票和计票，确认大多数人都收妥了记账数据并无异议，再将记账数据存下来，开始下一轮。

可以形象的描述下：一个团体，比如有7个人，大家都有投票权，要对某次聚餐计划的选择进行投票，这个时候某一个人发起一个提议，大家看ok呀，纷纷举手，提议的人定时数数，举手的人超过4个，就达成决议，否则再换一个人提议。如果提议达成，决定了吃什么什么时候吃，发起人给大家群发个邮件制定日程，大家接受日程并给出反馈，当看到有不少人都接受了邮件日程不会反悔，那么，这顿饭就成行了。

如果团队人数较多，也是可以让一部分人成为投票代表，比如一个上百人的班里，由选出来的班干部投票就可以了。其他人成为“观察者”，无条件接受这一部分人通过拜占庭容错算法得出的结果，和DPoS的思想类似。

总结一下PBFT：

- 谁在这个网络里有记账权，也就是做为leader发起一次记账。
  --所有人平等的轮流参与记账，或者经过许可的，或者大家选出来的一拨人进行轮流记账。
- 做为互相不信任的参与者，为什么要接受和相信某一个人给出的记账。
  ---少数服从多数，每次记账的结果都是多数派的投票胜利。
- 怎么保证大家最终收到的结果都是一致的，无错的。
  ---通过多步提交反复确认，保证提案和最终结果都是正确的，是多数人承认的，是全网一致的。

Raft，简单的说可以理解成大家选出一个记账者，如果它稳定运行没有挂掉，就由他记账，大家无条件接受他的记账结果，相信他是诚实的，如果他挂掉了，那么大家是可以通过超时或网络探测感知，然后快速启动一轮投票，来选出一个新的记账者，然后继续无条件的等它记账，这样就达成了容错性。

Raft适合用于专注解决可用性（保持系统稳定运行），追求相对较高效率（比优化后的PBFT大致高20~50%的效率）的场景，基本忽略欺诈可能，且对交易延时要求可以放宽（等待多次确认）。

为了在速度和抗欺诈之间获得平衡，也有出现PBFT-Raft混用的共识，比如让一个记账者固定出块，其他人极少轮次的投票，或者进行快速的后置检测，如果发现Raft的记账者在作恶，立刻回滚冲正，并踢掉并惩罚作恶的记账者等等，这就有一些场景化的需求需要考虑了。

总结一下Raft：

- 谁在这个网络里有记账权，也就是做为leader发起一次记账。
  --选出一个记账者，让他做为唯一的可信者进行记账，除非挂掉。
- 做为互相不信任的参与者，为什么要接受和相信某一个人给出的记账。
  ---无条件相信记账者，from the beginning till the last,至死不渝。
- 怎么保证大家最终收到的结果都是一致的，无错的。
  ---记账者说的都是对的，大家都用他的数据，是一致的。

## 文章：[浅谈以太坊智能合约的设计模式与升级方法](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%85%E8%B0%88%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%8D%87%E7%BA%A7%E6%96%B9%E6%B3%95%EF%BB%BF)

**摘要**：

部署了区块链系统的节点（物理机或者虚拟机），通过以太坊EVM虚拟机，可以运行图灵完备的智能合约（简单来讲，一切可计算的问题都能计算，这样的虚拟机或者编程语言就叫图灵完备的），从而解决真实世界中的复杂商业逻辑和应用的问题。

智能合约和传统应用程序有什么区别呢？

- 一是由于区块链运行机制的原因，智能合约的运行即使是异常运行都会在所有区块链节点上独立重复运行。因此，无论是在公有链还是联盟链运行智能合约都是非常昂贵（运算资源、存储资源）的操作。
- 智能合约一经发布于区块链上就无法篡改，即使智能合约中有Bug需要修复或者业务逻辑变更，它也不能直接在原有的合约上直接修改再重新发布。因此在设计之初就需要结合业务场景考虑合理的升级机制。

从业务视角来看，智能合约只需要做两件事，其一是如何定义数据的结构和读写方式，其二是如何处理数据并对外提供服务接口。在复杂业务逻辑场景中经过实践探索得到的最佳模式是**把业务控制逻辑和数据从合约代码层面做好分离**，即把合约分成两类：控制器合约（Controller Contract）与数据合约（Data Contract）。

- 控制器合约：`+doSomeThing()` 通过访问数据合约获得数据，并对数据做逻辑处理，然后写回数据合约，专注于对数据的逻辑处理和对外提供服务；
- 数据合约：`-data`, `+getData()`, `+setData()` 专注于数据结构定义与所存储数据的读写裸接口。为了达到数据统一访问管理和数据访问权限控制的目的，最好是将数据读写接口只暴露给对应的控制器合约。禁止其他方式的读写访问。

基于这个模式，遵循从上至下的分析方式，从对外提供的服务接口开始设计各类控制器合约，再逐步过渡到服务接口所需要的数据模型和存储方式，进而设计各类数据合约，可以较为快速的完成合约架构的设计。

文章给出了一些实用设计案例。注意代理控制器合约和命名空间控制器合约的设计。

在CD模式下，根据控制器合约与数据合约之间的操作关系，从逻辑上归结为四类：（具体参考实用设计案例）

- 控制器合约与数据合约 1->1
- 控制器合约与数据合约 1->N
- 控制器合约与数据合约 N->1
- 控制器合约与数据合约 N->N

在CD模式下，在业务逻辑变更需要升级合约的情况下，根据控制器合约与数据合约的升级关系来划分，可以归纳为以下三种情况：

| 控制器合约 | 数据合约 |
| ---------- | -------- |
| 升级       | 不升级   |
| 不升级     | 升级     |
| 升级       | 升级     |

在升级过程中，还需要考虑是全量升级还是灰度升级？如果是灰度升级，灰度策略是怎么样的？另外，在多链场景和单链场景、跨链场景，升级过程是否有不同？多链场景的灰度策略如何考虑？新旧版本数据能否共存？如果需要数据迁移，如何做到无缝迁移?具体参考升级场景举例。

数据迁移：

- 硬编码迁移法（新版本的数据合约中保存一个指向旧版本数据合约的合约地址，新版本数据合约保存的是增量的数据内容）
- 硬拷贝迁移法（新版本和旧版本之间切断逻辑关系，利用外部迁移工具，将旧版本数据逐步拷贝到链下，再从链下重新存储到新版本合约的过程）
- 默克尔树迁移法（拥有上两种方法的所有优缺点，简单高效，推荐使用）

## 文章：[浅谈Ethereum的存储](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%85%E8%B0%88Ethereum%E7%9A%84%E5%AD%98%E5%82%A8)

**摘要**：

区块(Block)是以太坊的核心数据结构之一，Block包含Header和Body两部分。区块的存储是由leveldb完成的，leveldb的数据是以键值对存储的。 所有与交易，操作相关的数据，其呈现的集合形式是Block(Header)；如果以Block为单位链接起来，则构成更大粒度的BlockChain(HeaderChain)；若以Block作切割，那么Transaction（交易）和Contract（合约）就是更小的粒度；所有交易或操作的结果，将以各个个体账户的状态(state)存在，账户的呈现形式是stateObject，所有账户的集合受StateDB管理。

区块存储的数据格式如下图所示：

![image](https://github.com/FISCO-BCOS/Wiki/raw/master/%E6%B5%85%E8%B0%88Ethereum%E7%9A%84%E5%AD%98%E5%82%A8/images/ethereum_database.png)

**以太坊的数据库体系**-Merkle-Patricia Trie(MPT)，是二叉树结构，叶节点存储源数据，父节点是两个子节点的HASH值，一直到根节点。Blockchain和HeaderChain， **Blockchain**管理所有的Block, 让其组成一个单向链表。**Headerchain**管理所有的Header,也形成一个单向链表， Headerchain是Blockchain里面的一部，**Transaction**是Body的重要数据结构，一个交易就是被外部拥有账户生成的加密签名的一段指令，序列化，然后提交给区块链。详见原文。

在以太坊中，**账户**的呈现形式是一个stateObject，所有账户受StateDB管理。详见原文。

**交易存储**：一个交易就是被外部账户签名的一段序列化后的指令。

**以太坊智能合约存储方式及执行**：智能合约可以简单的理解为一段可执行的程序片段，具体的代码由发布人使用特定的编程语言来编写（以太坊使用的是Solidity编程语言），在本地编译成功后可以发布到区块链上。而以太坊的智能合约也可以理解为一个特殊的交易（包括可执行代码的），被发送出去后会被矿工打包记录在某一个区块中，当需要调用这个智能合约的方法时只需要向这个智能合约的地址发送一笔交易即可。

**以太坊智能合约中的存储**：2^256个32字节值的数组，全部初始化为零。

## 文章：[区块链平台调研与分析报告.pdf](https://github.com/FISCO-BCOS/Wiki/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0%E8%B0%83%E7%A0%94%E4%B8%8E%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A.pdf)

**摘要**：

针对Ethereum、Hyperledger Fabric、Corda、BCOS等四个区块链技术平台，从平台架构、核心技术组件、应用功能、技术能力、安全机制、适用性、开发及工具、维护支持能力等八个方面进行了对比分析。

**架构灵活性**：Fabric采用了松耦合的设计，将共识机制、身份验证等组件模块化，在应用的过程中可以根据应用场景选择相应的模块；BCOS共识算法模块采用了插件化设计实现，通过修改系统配置，实现在多个联盟链里使用不同的共识机制，参与到同一个联盟链的所有节点必须采用同一种共识配置。

**节点分类**：Fabric把节点分成验证节点和非验证节点，通过授权和证书管理节点；BCOS把节点分为共识节点和观察节点，共识节点参与共识算法，成为链上的记账者，观察节点则不参与共识，只同步数据。

**核心技术组件**是指区块链系统所依赖的基础组件、协议和算法，可以进一步细分为通信、存储、安全机制和共识机制四个方面。

**共识机制**是区块链系统中各个节点达成一致的策略和方法。主流的有：PoW（工作量证明机制）、PoS（权益证明机制）、DPoS（委托授权的权益证明机制）、Raft、PBFT（实用拜占庭容错算法）

![](https://ws1.sinaimg.cn/large/006gWMKily1fyuypkkl9rj30nn074jst.jpg)

Fabric目前使用PBFT，BCOS目前使用PBFT、Raft（通过配置修改，但同一联盟链中必须相同）

![](https://ws1.sinaimg.cn/large/006gWMKily1fyvngl14txj30d104kt92.jpg)

**存储**：区块的数据结构通常只能追加记录而不能删除或者修改，为的是让新加入的节点对全网的完整交易历史进行验证，随着历史数据的增长，存储开销必然会影响整个系统的可扩展性。Ethereum和Fabric与比特币一样，使用Merkle树存放交易散列，在面临不断增长的数据时，一旦需要回收硬盘空间，可以选择将老旧的交易从Merkle树中剔除（具体实施方法存在争议）。除此之外Ethereum和Fabric可以使用状态快照（区块头除记录当前区块所有交易的根散列外，还记录着当前区块及过去所有区块中的状态根散列）节约空间（可以情况状态快照之前的交易历史，全量历史记录可以存储在中心存储上，由于状态根散列的存在，全量历史记录依旧无法伪造篡改）。BCOS支持分组多副本方式存储文件，并在区块链中保存文件的哈希值和相关寻址信息，提高区块链的存储和网络同步效率。BCOS还支持分布式数据存储的方案，如数据仓库、数据库集群等存储区块链数据。

**计算效率**：交易并行验证方面，Fabric没有好的解决方案，BCOS可以利用集群化、分片机制，使交易按一定的规则互相隔离，可被并行处理，且数量可以通过垂直切分的方式，分布存储在不同的存储设备上，满足性能和容量平行扩容的需求。

**特权机制**：智能合约DAO攻击（）

**技术能力**，包括吞吐量，确认时间，可用性三个方面

**吞吐量**：Fabric 1000+TPS；BCOS 在4节点环境下，转账交易的合约调用，性能可达到数千TPS，通过平行扩展，可满足更高服务需求。

**确认时间**：BCOS支持动态配置确认时间，其所采用的共识算法均支持1秒出块，出块即达成共识。

Ethereum更适用于并发性不高、以公有链为主的应用场景；Fabric和BCOS适合以联盟链形式开展的金融服务、供应链管理、文化娱乐等多行业应用场景；Corda定位相对明确，更适合面向非公链、受监管的金融机构。

## BCOS

[Github: BCOS](https://github.com/bcosorg/bcos)

BCOS平台（取BlockChainOpenSource涵义命名）是深圳前海微众银行股份有限公司、上海万向区块链股份公司、矩阵元技术（深圳）有限公司三方共同研发并且完全开源的区块链底层技术平台。

### 文档：[BCOS使用说明书1.0](https://github.com/bcosorg/bcos/blob/master/doc/manual/manual.md)

**摘要**：



### 文档：[BCOS平台白皮书](https://github.com/bcosorg/whitepaper/blob/master/BCOS_Whitepaper.md)

**摘要**：

#### 1. 分布式商业与技术

分布式商业以多方参与、智能协同、专业分工、价值分享等为主要特征，典型的应用场景有银行联合贷款、银证信保的多方产品合作、N+N供应链金融、分布式能源、分布式电商以及各类共享经济等。

为了实现分布式商业的对等、共享与透明规则，以开源为主要特征的分布式技术得以发挥优势，区块链技术、分布式账本技术等渐渐成为了前沿科技的核心代表。

集中式的传统技术架构因其较高的投入、较差的弹性、对少数几家厂商过度依赖而面临发展瓶颈，技术上陷入“大而不能倒”的窘境，并难以实现对新型商业模式的有效支撑。

而在分布式商业模式下，参与各方具有平等地位，专注各自领域且足够成熟，在此基础上，采用基于对等架构的技术平台实时交换和共享数据，同时接入多家合作方，可以有效提升商业上的容错性，从而避免商业上的“大而不能倒”的情况发生。

因此，以区块链为代表的**分布式账本技术**的价值逐渐凸显。区块链技术是一种在对等网络环境下，通过透明和可信规则，构建不可伪造、不可篡改和可追溯的块链式数据结构，实现和管理可信数据的产生、存取和使用的模式。广义上，这是由分布式架构与分布式存储、块链式数据结构、点对点网络、共识算法、密码学算法、智能合约等多种信息技术共同组成的整体解决方案。

区块链技术的应用最早从金融行业起步，并逐步向各个行业渗透。由于金融行业参与者群体广泛，而不同类型的金融机构其资质、资本、资源等禀赋各异、互补性较强，因此通常是以同业合作的对等形式共同设计产品或开展业务，如银银、银信、银保、证信合作等，天然形成了较多分布式商业场景的雏形，在某种程度上，分布式商业是传统金融同业合作模式的升华。

同时，健康医疗、物联网、工业互联网、能源服务、物流、供应链等多个领域也都存在类似需求与要求，这亦对区块链底层平台提出了较高的要求，为区块链技术与分布式商业的融合提供了演进的路线参考。

区块链技术在中国进行大规模的商用仍然存在以下**六点挑战**。

- **政策可行性**——是否与现有的技术监管、行业监管、技术治理、技术合规等要求符合，是否需要政策、法律、法规等的修改与支持；
- **性能可用性**——是否满足大量用户、高并发量、快速响应时间、大量存储等的可用性要求；
- **业务适当性**——是否能解决传统中心化技术难以解决业务痛点，带来新的分布式商业模式变革；
- **安全可控性**——是否符合特殊行业的高安全级别要求，是否采取了各种必要的安全手段，保障链上资产和交易等信息的安全、可防范攻击等；
- **技术使用难度**——是否通过规范开发语言、接口标准、友好平台等途径，降低应用难度，便于无技术积累的企业也能快速灵活加入使用；
- **治理难度**——是否对区块链系统与传统系统的结合与互补有所考虑，是否规划设计了综合型系统的治理方法，对所有资源或对象进行统筹管理等。

#### 2. 区块链治理

治理就是如何设计区块链系统，使它能够和传统系统形成结合与互补。

##### 2.1 区块链治理模式

作为一个服务分布式商业的、广泛适用各个行业领域的区块链底层技术平台，BCOS平台或将面临功能模块不断增加、系统环节愈加复杂、交互的系统愈加广泛、参与对象逐渐增多、管理难度逐渐扩大等挑战，如缺乏科学的信息技术管理与治理观念，将无法实现可持续发展。因此，我们引进借鉴了国际上通用的信息技术系统治理标准--**COBIT模型**。

![](https://github.com/bcosorg/whitepaper/raw/master/images/i3.1.jpg)

区块链的**治理准则维度**集中反映了系统的战略目标，主要从质量、成本、时间、资源利用率、系统效率、保密性、完整性、可用性等方面来保证区块链系统的安全性、可靠性、有效性。

区块链的**治理对象维度**主要包括以参与者、共识机制、节点、应用系统、算法、底层设施及数据在内的区块链相关的资源。

区块链的**治理过程维度**则是在治理准则的指导下，对区块链的信息及相关资源进行规划与处理，从规划与组织、采集与实施、交付与支持、安全与监控等多个方面确定区块链的处理过程，并赋予每个处理过程详细的控制目标、审计方针及评估方法。

##### 2.2 区块链治理准则

具体而言，BCOS平台将遵循以下五大治理原则：

1. **合法合规原则**：遵守国家相关法律法规和监管要求，为监管审计需求提供技术支持；
2. **可追溯原则**：业务与活动都有记录，可追溯，可审计；
3. **安全原则**：采取各种必要的安全手段，保障链上资产和交易等信息的安全，防范攻击；
4. **隐私保护原则**：保障链上的用户隐私安全，防止泄露用户隐私；
5. **业务导向原则**：以需求推动技术，设计与开发时优先考虑适用的业务场景，通常需要对原有业务流程进行重新梳理。一方面在保持合规性的同时要使区块链技术特性得以充分发挥，另一方面还须考虑如何为业务带来怎样的改善与价值创造。

区块链技术的治理可深入至技术的核心环节如共识机制、节点准入、权限管理等，通常可划分为公有链、联盟链、私有链三种形式。BCOS平台综合考量后，选择了联盟链的部署架构与治理模式。

##### 2.3 区块链治理对象

区块链的治理对象维包含参与者与技术系统的多个方面，如身份认证、节点管理、共识机制、隐私保护、监管审计，具体参见白皮书原文。

###### 2.3.1 身份认证

一个机构拥有一个到多个区块链节点，节点接入到联盟链的网络中，代表其所属机构在链上进行活动，包括同步数据、参与共识、发起交易等，机构和节点是一对多的关系，为了达成机构级别的安全控制和审计监管，首先需要对机构进行身份认证和准入控制。（基于CA的身份认证和准入，一个链有一个链证书，用于签发机构证书，机构证书签发节点证书，节点之间通信使用节点证书建立SSL连接）

BCOS平台支持的采用CA证书实现机构身份认证的机制与流程如下：

- 机构将自己的机构基本信息（名称，机构编号，联系方式等）以及所属节点的信息（IP地址，节点标识等），以及CA公钥证书提交给联盟链运营管理者，统一进行准入审核。
- 如机构准入审核被通过，联盟链运营管理员将该机构的节点信息，CA公钥证书向全联盟链广播，告知全部参与者，将新机构的新节点接入到网络，链上已活动的节点应允许新节点进行连接和进行握手。
- 在节点互相连接时，节点之间会采用CA证书里的私钥对自己的握手信息进行签名，发送给对方，接收方根据发送方的握手信息查询CA公钥证书，并使用公钥证书进行签名验证，以判断是哪个机构的节点发起的连接，是否允许继续通信。
- 证书管理服务会定期检测机构的证书状态，判定证书是否有效，如是否过期、被吊销等。如证书已经失效，则该机构的节点再尝试连接到网络时会被拒绝。

###### 2.3.2 节点管理

节点指安装了区块链软件的物理服务器或虚拟服务器，这些服务器可连接到联盟链网络，具有可访问的IP地址、能对外提供服务。

从数据和共识参与程度来看，部分或全部节点可以设置为**共识节点**，参与共识算法，成为链上的记账者；不参与共识，只同步数据的节点称为**观察节点**。

节点的配置管理包括两个维度：**全网配置管理**及节点**本地配置管理**。

**全网配置**将参与网络的所有节点信息写入到链上共同维护的全局配置（==注册节点到系统合约记账节点列表？==），在此配置里的节点才能被链上其他节点接受，不存在该配置里的节点或配置有误的节点，又或节点的CA证书已经过期，都会被拒绝连接，如此实现了联盟链节点的准入机制。全网维护的全量节点信息包含了节点的IP地址、端口等，也可用于节点之间的通信寻址。

**本地配置**是全网配置的一个子集，在本地配置文件里实现，仅对本地节点生效，支持**黑白名单逻辑**。

**白名单**用于解决节点快速发现的问题，一个新接入的节点可以根据节点白名单，连接到已经被认为是可信的其他节点，进行数据同步、获取区块数据、全网配置等。当同步成功后，新接入的节点也拥有了和全网一致的全网配置，可以根据全网配置进行完整的连接控制，如包括CA认证等。

**黑名单**用于节点的自我保护，如出于安全、服务容量、网络可达性等原因，不能连接到某个其他节点，或者明确的不接受某个其他节点对自己的连接，则可以将该节点加入自己的黑名单配置，则这个节点对自己的连接将会被拒绝，自己也不会去连接这个节点，实现了通信层面的隔离。

###### 2.3.3 共识机制

共识机制不但是计算机之间的算法和数据共识，也是合作伙伴之间进行协作的共识，共识机制使区块链的参与者通过约定的方式进行共同记账，确保合作者之间的记账正确性、一致性、持续性，避免少数出现故障的节点影响网络运行，并防御少数故意作恶者的破坏。

公有链如比特币、以太坊等使用的共识算法通常为工作量证明或权益证明等，可以根据投入权益和记账的行为，对记账者制定奖励和惩罚制度（代币）。公有链上的共识算法一般确认时间较长，或需要较多的算力投入。

联盟链共识机制的设计目标和公有链有所不同，BCOS平台不会根据记账的计算量对记账者进行经济奖励，而是鼓励参与者在共同维护联盟链、促进生态系统发展、推进商业合作的过程中获得价值或收益。在此过程中产生的纠纷或非法行为，将采用监管审计和法律仲裁结合的方式解决。BCOS平台共识机制的实现符合联盟链场景需求，可避免算力浪费、防分叉和提升运行稳定性。

BCOS平台采用高效的**PBFT**（实用拜占庭容错算法）、**RAFT**共识算法，采用插件化设计实现，通过修改系统配置，即**可以在一个联盟链里使用不同的共识机制，参与到这个联盟链的所有节点必须采用同一种共识配置**。具体算法流程参考原文。

联盟链的共识算法在节点总数不多、网络规模不太大时，可以提供较高的交易并发处理能力。但随着节点数量增多，比如达到几百个共识节点的规模时，由于需要共识节点之间交换较多的信息，会出现明显的性能下降。所以在联盟链中一般会通过协商，在保证公平公开的前提下，控制参与者共识的节点数量，以保证共识算法的效率。

###### 2.3.4 隐私保护

零知识证明、同态加密等新密码学算法的探索性使用。

在一些强监管或高安全要求的业务场景中，可以引进官方或权威的中央对手方提供信用背书，通过物理隔离与通信层的逻辑通道设计，交易明细仅发送给交易牵涉的节点以及中央对手方，从基础层面防止了隐私数据的扩散。

- 高敏感性的数据脱敏后再上链。
- 提供机构和机构之间点对点通信方式，数据通信仅发生在相关的机构之间，当机构之间针对交易数据完成校验和协商之后，仅把需要对全网确认共识的数据发送到联盟链上进行共享。
- 数据明细在链下保存，链上提供共识过的数据摘要、数据有效性证明、对数据的寻址方法、数据访问授权约定等，供机构之间在必要时通过数据下载协议获取可信的数据。分布式文件服务和存证类业务可以考虑采用类似方式，在链下保存图片、视频、其他类型的大文件，并将其摘要发送到链上获得有效性证明，这种方式可以同时解决数据容量和敏感性的问题。
- 数据可以对全联盟链进行广播，但采用高强度的加密数据信封方式进行保护，仅在交易参与方以及中央对手方、监管方之间共享数据，但未参与的的机构收到的是密文，且不能解密这份数据。
- 在部分只涉及到数据数值加减的场景，可采用加法同态加密算法，实现对数据的隐私保护，同时不会对性能有大的影响。
- 在部分能承受一定效率损耗, 并且涉及到复杂数据操作的交易场景，采用零知识证明，多操作同态加密等算法，用密码学方式实现隐私保护。

###### 2.3.5 监管与审计

BCOS平台一方面**提供可监管的数据接口**，另一方面可**支持监管部门作为特殊节点接入**，可即时同步数据，并对数据完整性、有效性、过程和流程的合规性进行即时的监控，从而可对异常或违规行为及时处理或给予指导意见。

不管是哪种角色（开发者、交易管理员、联盟链运营者、运维者、监管方），都要根据业务场景定制精确的角色权限集合，只给予每个角色必须的权限。

可以参考原文中举例的强监管场景（可支持监管方作为所有规则的制定者和实施者）和中度监管场景（可支持监管方选择性地参与到交易过程）。

**事前、事中、事后审计的有机结合**（审计节点接入进行实时监控和审计，事后通过区块链数据同步的特性，审计所有的数据，进行业务合规检查、反洗钱等操作）

##### 2.4 区块链治理过程

对具体的区块链事务流程，需要设计一系列的交付目标、相应的控制程序、以及评价执行效果的监控程序。

###### 2.4.1 交付与支持

使用BCOS平台构建应用的工作主要包括搭建联盟链、编写合约、开发客户端应用、以及运营管理和升级维护。

> 合约的**灰度升级机制**：可以通过灰度方式进行验证和逐步放量，如先使用测试数据进行验证，或将业务交易的流量按用户、商家、交易类型等维度分组，把交易逐步从旧合约切换到新合约上执行，待新合约逻辑验证通过，再全量切换到新合约，否则回退到上个版本的合约继续运行。

> 如同微信的灰度发布：主要是按照一定策略选取部分用户，让他们先行体验新版本的应用，通过收集这部分用户对新版本应用的反馈（如：微博、微信公众号留言或者产品数据指标统计、用户行为的数据埋点）以及对新版本功能、性能、稳定性等指标进行评论，进而决定继续放大新版本投放范围直至全量升级或回滚至老版本。

BCOS平台提供了友好的SDK，在SDK基础上开发面向最终用户的、界面友好的、可交互的、功能丰富的客户端程序，以HTML/HTML5、PC或手机终端软件等多种形式呈现，在客户端上可以保存链上部分或全部的数据，也可以作为轻客户端访问链上节点。其中，轻客户端的安全策略与节点类似，将设置准入控制、身份认证及权限管理等。

###### 2.4.2 运维与监控

运维人员对联盟链的操作会被权限系统控制，运维人员有修改系统配置、启停进程、查看运行日志、排查故障等权限，但不参与到业务交易中，也不能直接查看具有较高安全隐私等级的用户数据，交易数据。

监控的维度包括**基础环境监控**（如CPU占比、系统内存占比和增长、磁盘IO情况、网络连接数和流量等）、**区块链系统监控**（区块高度、交易量和虚拟机计算量，共识节点出块投票情况等）、**接口监控**（接口调用计数、接口调用耗时情况、接口调用成功率等）。

监控数据可以通过日志或网络接口进行输出，便于和机构的现有的监控系统进行对接，复用机构的监控能力和既有的运维流程。运维人员收到告警后，采用联盟链提供的运维工具，查看系统信息、修改配置、启停进程、处理故障等。

#### 3. 开源平台技术特征

BCOS平台总体架构图

![image](https://github.com/bcosorg/whitepaper/raw/master/images/i4.1.png)

#### 4. 技术路线

##### 4.1 多链和跨链

根据业务功能、隐私保护、数据隔离、或者性能容量扩展的需求，建立多个独立的链并行工作，链和链之间可以通过跨链服务进行交互，如发送交易，查询交易结果，读取配置数据等。

##### 4.2 分布式存储

现有区块链实现中，每个节点存储全量区块链数据，数据冗余度较高，且数据容量受单机存储硬件影响，在海量服务中，如需存储较长时间段的数据，其数据量一般不是单服务器能容纳的。

区块链数据一般采用文件型本地数据库如leveldb，在本节点的物理硬盘上基于文件系统保存，不提供跨网络的存储结构。而在对数据安全要求较高的机构里，数据一般存储在和外网隔离的安全区域里，以保障数据的安全。同时，这些机构已经建立了成熟的数据存储和维护方案，在基础架构层面保障数据存储服务的高可用、可扩容、可迁移、可维护，并和大数据平台等系统进行整合。

采用分布式数据存储的方案，可综合考虑数据的容量、可维护性、安全性，支持使用现有的企业级分布式存储解决方案，如数据仓库、数据库集群等存储区块链数据。

##### 4.3 隐私保护

多层次的隐私保护：

- **身份匿名**：使用群签名进行身份匿名，同时监管方可对用户身份进行跟踪。
- **数据隐私保护**：已经在客户端和智能合约上实现加法同态加密算法，计划增加零知识证明用于证明加密数据的正确性（如账户余额数据是否足够用于支付）
- **细粒度的权限控制**：基于属性加密算法和代理授权密码算法的多级访问控制，用于控制对加密数据的隐私访问。

##### 4.4 虚拟机优化

计划支持JVM虚拟机和Java开发语言。

##### 4.5 可信信息管理

“预言机”解决方案。

#### 5. BCOS平台的行业应用实践

- 联合贷款备付金管理及对账平台
- 供应链金融服务平台
- 中小微企业股权登记与服务平台

#### 参考文献

- [1] ISACA 《COBIT 5: A Business Framework for the Governance and Management of Enterprise IT》
- [2] 中国区块链技术和产业发展论坛 《**中国区块链技术和应用发展白皮书**》
- [3] 中国区块链技术和产业发展论坛 《**区块链参考架构**》

### FISCO BCOS

FISCO BCOS平台是金融区块链合作联盟（深圳）（以下简称：金链盟）开源工作组以金融业务实践为参考样本，在BCOS开源平台基础上（BCOS又是基于Ethereum深度定制的，所以Ethereum里面的很多概念都是适用于BCOS和FISCO-BCOS的）进行模块升级与功能重塑，深度定制的安全可控、适用于金融行业且完全开源的区块链底层平台。

[Github: FISCO-BCOS/Wiki](https://github.com/FISCO-BCOS/Wiki)

- 区块链知识&行业动态

    *  [区块链平台调研与分析报告](https://github.com/FISCO-BCOS/Wiki/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%B9%B3%E5%8F%B0%E8%B0%83%E7%A0%94%E4%B8%8E%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A.pdf)
    *  [区块链应用系统开发TIPS](https://github.com/FISCO-BCOS/Wiki/tree/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91TIPS)
    *  [漫谈系列：联盟链的权限体系](https://github.com/FISCO-BCOS/Wiki/tree/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E6%9D%83%E9%99%90%E4%BD%93%E7%B3%BB)
    *  [漫谈系列：共识机制](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%BC%AB%E8%B0%88%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6)
    *  [漫谈系列：浅谈以太坊智能合约的设计模式与升级方法](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%85%E8%B0%88%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%8D%87%E7%BA%A7%E6%96%B9%E6%B3%95%EF%BB%BF)
    *  [漫谈系列：浅谈Ethereum的存储](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%85%E8%B0%88Ethereum%E7%9A%84%E5%AD%98%E5%82%A8)
    *  [漫谈系列：聊聊区块链数据的“安全”和“控制权”](https://github.com/FISCO-BCOS/Wiki/tree/master/漫谈系列：聊聊区块链数据的“安全”和“控制权”)
    *  [漫谈系列：区块链应用后台混合架构介绍](https://github.com/FISCO-BCOS/Wiki/tree/master/漫谈系列：区块链应用后台混合架构介绍)

- FISCO BCOS技术指引

    * [FISCO BCOS实践指引（建议优先阅读）](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO%20BCOS%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%BC%95)
    * [FISCO BCOS“极简”Java应用开发入门](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO%20BCOS%E2%80%9C%E6%9E%81%E7%AE%80%E2%80%9DJava%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8)

- FISCO BCOS特性介绍
    * [FISCO BCOS特性介绍](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E7%89%B9%E6%80%A7%E4%BB%8B%E7%BB%8D.pdf)
    * [并行计算介绍](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO-BCOS%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97%E4%BB%8B%E7%BB%8D)
    * [系统合约介绍](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO-BCOS%E7%B3%BB%E7%BB%9F%E5%90%88%E7%BA%A6%E4%BB%8B%E7%BB%8D)
    * [共识算法优化](https://github.com/FISCO-BCOS/Wiki/tree/master/%E5%BA%94%E7%94%A8%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%A4%9A%E8%8A%82%E7%82%B9%E5%B9%B6%E8%A1%8C%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%AE%B9%E9%94%99%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95)
    * [CNS合约命名服务](https://github.com/FISCO-BCOS/Wiki/tree/master/Contract_Name%20Service%E6%9C%8D%E5%8A%A1)
    * [链上信使协议AMOP](https://github.com/FISCO-BCOS/Wiki/tree/master/AMOP%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)
    * [易用性提升](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%85%E8%B0%88FISCO-BCOS%E7%9A%84%E6%98%93%E7%94%A8%E6%80%A7)
    * [FISCO BCOS权限模型](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO%20BCOS%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B)
    * [系统参数说明文档](https://github.com/FISCO-BCOS/Wiki/tree/master/%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3)  
    * [FISCO BCOS上帝模式说明](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E4%B8%8A%E5%B8%9D%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E/README.md)  
    * [FISCO BCOS和以太坊差异综述](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E5%92%8C%E4%BB%A5%E5%A4%AA%E5%9D%8A%E5%B7%AE%E5%BC%82%E7%BB%BC%E8%BF%B0/README.md)  

- FISCO BCOS应用案例
    * [FISCO BCOS案例精编](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E6%A1%88%E4%BE%8B%E7%B2%BE%E7%BC%96/README.md) 
    * [FISCO BCOS应用实践](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pdf) 
    * [存证案例说明](https://github.com/FISCO-BCOS/Wiki/tree/master/%E5%AD%98%E8%AF%81sample%E8%AF%B4%E6%98%8E) [案例源码](https://github.com/FISCO-BCOS/evidenceSample)
    * [微粒贷机构间对账平台](https://github.com/FISCO-BCOS/Wiki/blob/master/%E3%80%90FISCO%20BCOS%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B%E3%80%91%E5%BE%AE%E7%B2%92%E8%B4%B7%E6%9C%BA%E6%9E%84%E9%97%B4%E5%AF%B9%E8%B4%A6%E5%B9%B3%E5%8F%B0/README.md) 
    * [“仲裁链”：基于区块链的存证实践](https://github.com/FISCO-BCOS/Wiki/blob/master/%E3%80%90FISCO%20BCOS%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D%E3%80%91%E2%80%9C%E4%BB%B2%E8%A3%81%E9%93%BE%E2%80%9D%EF%BC%9A%E5%9F%BA%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%AD%98%E8%AF%81%E5%AE%9E%E8%B7%B5/README.md) 
    * [海量存证数据 + 区块链实现](https://github.com/FISCO-BCOS/Wiki/tree/master/%E6%B5%B7%E9%87%8F%E5%AD%98%E8%AF%81%E6%95%B0%E6%8D%AE%20%2B%20%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E7%8E%B0) 


- 【RUN赋能计划】系列技术直播
    * [FISCO BCOS的安全架构](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84%E3%80%90RUN%E8%B5%8B%E8%83%BD%E8%AE%A1%E5%88%92%E3%80%91%E7%AC%AC%E4%B8%80%E6%9C%9F/FISCO%20BCOS%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84%E3%80%90RUN%E8%B5%8B%E8%83%BD%E8%AE%A1%E5%88%92%E3%80%91%E7%AC%AC%E4%B8%80%E6%9C%9F.md)

- 常见问题
    * [FISCO BCOS常见问题](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO%20BCOS%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/README.md)

- English Version
    * [English wiki document](https://github.com/FISCO-BCOS/Wiki/tree/master/en)

[Github: FISCO-BCOS](https://github.com/FISCO-BCOS/FISCO-BCOS)：包含源码、使用文档、技术白皮书。



#### 文档：[FISCO BCOS Documentation 使用文档](https://fisco-bcos-documentation.readthedocs.io/zh_CN/latest/)

**摘要**：

手工搭链：环境要求，程序部署，基础配置，创世节点，增加节点

使用指南：区块链节点，证书说明，合约入门，系统合约，基本操作，控制台

高级合约调用（web3sdk）：环境要求，SDK编译，配置文件，应用开发指南，SDK功能列表

企业搭链工具（物料包）：环境依赖，部署区块链，扩容节点，部署区块链sample，FISCO BCOS docker，JAVA安装，物料包web3skd配置，CheckList，日志清理脚本`rmlogs.sh`，节点监控脚本`monitor.sh`

国密版FISCO BCOS：环境要求，编译安装，证书生成，SDK证书，搭建创世节点，普通节点环境搭建，节点入网，国密版web3sdk搭建

特性详解：总体介绍，基础特性，性能，易用性，安全

应用实践：落地应用，前沿应用sample

Wiki：RUN赋能计划系列直播，漫谈系列，技术分析

==根据以上描述，使用web3sdk开发区块链应用主要包括如下过程：==

- 根据应用功能设计合约数据结构和接口;
- 编写智能合约，可先用Nodejs简单验证合约代码逻辑是否正确，验证通过后，将- 合约代码转换成java代码
- 编写java应用，调用合约java接口完成合约部署和调用功能
- 配置并编译java应用
- 应用功能测试

#### 文档：[智能合约开发 Solidity Document](https://solidity.readthedocs.io/en/v0.5.2/)

Solidity受C ++，Python和JavaScript的影响，旨在针对以太坊虚拟机（EVM）。

如果您不熟悉智能合约的概念，我们建议您从一个用Solidity编写的[智能合约示例](https://solidity.readthedocs.io/en/v0.5.2/introduction-to-smart-contracts.html#simple-smart-contract)开始 。当您准备好了解更多细节时，我们建议您阅读 “[按实例确定](https://solidity.readthedocs.io/en/v0.5.2/solidity-by-example.html)”和“[深度稳定性](https://solidity.readthedocs.io/en/v0.5.2/solidity-in-depth.html)”部分，以了解该语言的核心概念。

如需进一步阅读，请尝试[区块链的基础知识](https://solidity.readthedocs.io/en/v0.5.2/introduction-to-smart-contracts.html#blockchain-basics) 和[以太坊虚拟机](https://solidity.readthedocs.io/en/v0.5.2/introduction-to-smart-contracts.html#the-ethereum-virtual-machine)的详细信息。

您始终可以使用[Remix IDE](https://remix.ethereum.org/)在浏览器中试用代码示例 。Remix是一个基于Web浏览器的IDE，允许您编写Solidity智能合约，然后部署并运行智能合约。加载可能需要一段时间，请耐心等待。

**主要内容**：

智能合约简介：一个简单的智能合约，区块链基础知识（交易和块，区块链），以太坊虚拟机（账户、交易、Gas、Storage, Memory and the stack, ）；

安装Solidity Compiler；

Solidity by Example：表决Voting，Blind Auction 盲人拍卖，安全远程购买，小额支付渠道；

Solidity in Depth：Solidity源文件的布局，合同的结构，类型，单位和全局可用变量，表达式和控制结构，合同，Solidity Assembly；

安全考虑因素Security Considerations：陷阱Pitfalls，建议Recommendations，正式验证Formal Verification；

资源：Solidity Integrations, Solidity Tools, 第三方Solidity解析器Parsers和语法Grammars；

使用编译器：使用Commandline编译器，Setting the EVM vesion to target，编译器输入和输出JSON描述；

合同元数据Contract Metadata：在字节码中编码元数据HASH，自动接口生成和NatSpec的用法，源代码验证的用法；

合同ABI规范Specification：基本设计，功能选择器，参数编码，类型，编码的设计标准，编码的正式规范，函数选择器和参数编码，例子，使用动态类型，活动，JSON，严格的编码模式，非标准打包模式；

Yul：Specification of Yul，Specification of Yul Obeject

Style Guide：代码布局，布局顺序，命名约定Naming Conventions，NatSpec；

常见模式：退出合同Withdrawal from Contracts，限制访问Restricting Access，State Machine；

已知错误列表；

Contributing：如何报告问题，Pull请求的工作流程，运行编译器测试，通过AFL运行Fuzzer，Whiskers；

经常问的问题：基本问题，高级问题

**详细内容**：

##### 1. Introduce to Smart Contracts

###### 1.2 Blockchain Basics

区块链是一个全局共享的事务型数据库，任何人如果想要修改它，就需要发起一个交易，这个交易需要被其他人认可（共识），才能够修改数据库。这种修改是事务型的，要么全部完成修改，要么全部回滚放弃修改。区块链上的数据不会被真正删除，所有的数据都会存储在它的历史纪录中。

**Block**:

在以太坊中，交易和块是绑定在一起的，当绑定完成后，就将它们在所有的节点上执行和分发。

如何解决绑定过程中多个交易冲突的问题（即选择哪个交易与下一个块绑定）：

如果两个交易是互相矛盾的，而其中一个交易已经被判定为第二名了（==order selection mechanism, i.e. mining挖矿==），那么第二名的交易不会成为块的一部分。

这些块按照时间顺序串成链：区块链。

###### 1.3 The Ethereum Virtual Machine

**账户**：

账户分为两种：外部账户(state,i.e. 代币余额，balance in Ether)和合约账户（state+code）。外部账户由用户控制（by public-private keypairs），合约账户由账户中的code控制（当合约账户收到相应消息时，这些code就会被执行，从而改变其state）。

账户由账户地址唯一标识。外部账户的地址由账户公钥决定，合约账户的地址由nonce（合约创建者creator地址和creator已经发送的交易数目）决定，在合约被创建时生成。它们的地址空间都是一样的。

如果不考虑账户中的code，两种账户对于EVM来说都是平等的、一样的。

每个账户都有固定的存储空间（storage)，它是一个key-value mapping（256-bit words to 256-bit words）。

- 一个外部账户（外部控制的账户）中：
  - 有以太币的余额 balance in Ether（可以理解成账户的state）
  - 能发送交易（以太币的转移或者是触发合约代码）
  - 能被私钥控制
  - 没有关联代码
- 一个合约账户（简称合约）中：
  - 有以太币的余额（这里可以理解成state variables）
  - 有关联代码
  - 有交易发生（transaction）或者是从其他合约收到消息（message call）会触发代码的执行
  - 代码执行：
    - 可以执行任意复杂度的操作（图灵完备性）
    - 可以操作它的存储状态（例如，可以拥有它自己的持久状态。可以理解为修改自己的state variables）
    - 可以调用其他合约（message calls）

**交易**：

一个交易就是把一段信息从一个账户（发送账户，发起账户）发送到另一个账户（目标账户，接收账户），这段信息可以相同，也可以为空，也可以是二进制数据（payload）或代币（ether)。

如果交易的目标账户中包含code，这段code会被执行，而交易中携带的payload会被当成code的输入数据。

如果交易的目标账户没有设定，则交易创建一个新的合约，新合约的地址由发送者地址和它已经交易的数目决定（等同合约账户地址的生成）。此时，交易的payload会被当做EVM字节码执行，执行结果（output data）会被永久地存储为新合约的code。

这意味着，为了创建一个新的合约，我们不会直接发送合约code，而是利用交易中的payload返回合约code。

**Gas**：

在创建后，每一笔交易都会收取一定数量的Gas（==和ether是一个东西吗？FISCO BCOS中没有代币，如何表示Gas==），目的是限制执行交易所需的工作量并同时支付该执行。

当EVM执行交易时，the Gas会依据某种规则被逐渐耗尽。

Gas Price由交易创建者creator设定，由交易发起账户sending account支付，用剩的Gas会被退还到sending account。如果Gas不够用，会触发out-of-Gas异常，这将会恢复对当前调用帧状态所作的所有修改。

**Storage, Memory and the Stack**:

EVM有三个地方用来存储数据：Storage, Memory and the Stack

Storage：账户中的存储空间，key-value结构：256-bit word to 256-bit word

Memory: 一个合约为每个消息调用message call获取一个freshly cleared instance，类似于windows系统中应用程序运行时的内存空间。Memory是线性存储空间，可以进行字节级寻址。Memory的读取限制为256位宽，写操作可以是8位/256位宽。Memory以字（256bits）为单位扩展，内存的扩展也需要Gas。

Stack：EVM是一个stack machine, not a register machine, 即所有的计算在stack上执行。stack是一个最大支持1024元素（每个元素是256bits word）的列表，操作规则如下：

- 从栈顶访问，支持put push操作；
- 可以将最顶部的16个元素之一复制到栈顶，或者将栈顶元素与其下16个元素之一交换；
- 所有的运算都是针对栈顶的1到2个元素进行的，运算结果会重新push到栈顶；
- 可以将栈顶元素移动到storage or memory。

**指令集Instruction Set**：

所有指令操作都在基本数据单元上进行（256-bit word/slice of memory/other byte arrays）。

有算术运算、位运算、逻辑运算、比较运算；

支持有条件和无条件跳转；

此外合约可以访问当前块的相关属性，如Number and timestamp.

For a complete list, please see the [list of opcodes](https://solidity.readthedocs.io/en/v0.5.2/assembly.html#opcodes) as part of the inline assembly内联汇编 documentation.

**消息调用Message Call**：

一个合约可以通过message call调用其他合约，或者给非合约账户发送Ether（转账）。

message call和交易一样，也有：a source, a target, data payload, ether, gas and return data.

消息调用和交易的关系：一个交易中包含了一个顶级的消息调用。

消息调用中的gas消耗（参考原文）。

消息调用中被调用的合约会收到一个初始化了的memory，然后访问the call payload（被放置在一个叫做calldata的特殊区域），当合于执行完成后，返回的数据会被存储在caller's memory中的一块特殊划定的区域中，所有的调用都是完全同步的。

调用的深度限制为1024，这意味着对于更复杂的操作，循环应优先于递归调用。另外在消息调用中只能转发63/64的Gas，这在实践中导致深度限制略小于1000。

**Delegatecall/Callcode and Libraries**：

Delegatecall：消息调用的特殊变体，与消息调用的唯一区别在于 the code at the target address is executed in the context of the calling contract and `msg.sender` and `msg.value` do not change their values.

主要用于让合约在运行时动态加载其他地址上的code，此时，除了code来自called address之外，storage、当前地址和账户余额均指向calling contract。

这使得在solidity中实现“library”功能成为可能：Reusable library code that can be applied to a contract’s storage, e.g. in order to implement a complex data structure.

**Logs**：

solidity使用logs功能来实现[events](https://solidity.readthedocs.io/en/v0.5.2/contracts.html#events).

logs data只能从区块链外部访问。

因为logs data是存储在[bloom filters](https://en.wikipedia.org/wiki/Bloom_filter)中的，所以我们不需要下载全部区块链就能找到这些日志（支持轻客户端访问）

**create calls**：

合约可以通过create calls创建新的合约。

create calls和message calls的区别在于：create calls的caller中的payload会被执行，计算结果会被存储为新合约的code，caller/creator会在stack上收到新合约的地址。

**停用和自毁Deactivate and Self-destruct**：

从区块链中移除code的唯一方法就是：让代码所在的合约执行`selfdestruct`操作。详见原文。

注意：这里的`selfdestruct`并不是把合约从区块链上完全清除，合约依旧会存在在区块链的历史记录中，也可能依旧保存在大多数的以太坊节点中。



##### 2. Installing the Solidity Compiler

两个版本： releases和nightly（nightly development builds），生产开发环境建议使用releases版本。

**Remix** - Solidity IDE，用于开发小型contract或者快速学习Solidity。相关链接：[Remix online](https://remix.ethereum.org/), [Download Remix](https://github.com/ethereum/remix-live/tree/gh-pages)

**solc** - a commandline Solidity compiler，用于开发大型contract，或者定制化编译。相关链接：[Using the Commandline Compiler](https://solidity.readthedocs.io/en/v0.5.2/using-the-compiler.html#commandline-compiler)。

**solc-js** - solc的JavaScript版本，功能相对简单，使用npm安装：`npm install -g solc`。使用方法详见[solc-js repository](https://github.com/ethereum/solc-js)

**Docker部署**：`docker run ethereum/solc:stable --version `

**Binary Packages**：[solidity/release](https://github.com/ethereum/solidity/releases)，我们可以直接在ubuntu下用`apt`命令安装solc，或者从源码building，具体参考原文。

##### 3. Solidity by Example

**选票系统Voting**：

关键问题：如何把表决权力分配给对的人（how to assign voting rights to the correct persions）；如何阻止操纵投票(how to prevent manipulation)。

为每张选票Ballot创建一个合约， 合约的creator扮演chairperson的角色，由它把选票（合约）分发（发起交易）给每一个选民Voter（外部账户）。选民可以选

详见原文。

**Blind Auction盲人投票**

##### 4. Solidity in Depth

##### 5. Security Considerations

##### 6. Resources

##### 7. Using the compiler

##### 8. Contract Metadata

##### 9. Contract ABI Specification

##### 10. Yul

##### 11. Style Guide

##### 12. Common Patterns

##### 13. List of Known Bugs

##### 14. Contributing

##### 15 Frequently Asked Questions

#### 文档：[FISCO BCOS实践指引（建议优先阅读）](https://github.com/FISCO-BCOS/Wiki/tree/master/FISCO%20BCOS%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%BC%95)

**摘要**：

本文作为一个概括性的实践指引, 包含了FISCO BCOS的环境搭建、特性简介、业务实践的介绍预览, 可以使开发者对FISCO BCOS有一个全局性的认识, 更完整信息可以参考[Wiki](https://github.com/FISCO-BCOS/Wiki)。

#### 文档：[FISCO BCOS区块链操作手册](https://github.com/FISCO-BCOS/FISCO-BCOS/tree/master/doc/manual#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%A4%9A%E8%8A%82%E7%82%B9%E7%BB%84%E7%BD%91)



**摘要**：

**FISCO-BCOS 面向CA的准入机制**

FISCO-BCOS支持多链，建议一条业务一条链。

每一条链，都有链证书（公钥+身份信息等）和链私钥。

由链对每个参与该链的机构签发机构证书（机构自己持有机构私钥）；

机构对下属节点签发节点证书（节点自己持有节点私钥）

节点之间通过节点证书与其他节点之间建立SSL连接。

同一条链中的所有节点所属机构都必须是同一个链证书所签发。

**创世节点**

节点的启动依赖以下配置文件：

- 创世块文件：`genesis.json`（这里需要配置god账号，god账号是区块链的最高权限，在启动区块链前必须配置；每个节点都有个`NodeId`，将`NodeId`配置入`genesis.json`的`initMinerNodes`字段，即指定此`NodeId`的节点为创世节点。）
- 节点配置文件：`config.json`（配置节点的各种信息，包括网络地址，文件目录，节点身份等。字段说明请参看附录：*12.4 config.json说明*）
- 日志配置文件：`log.conf`（`log.conf`中配置节点日志生成的格式和路径。一般使用默认即可。）
- 连接节点文件：`bootstrapnodes.json`（节点启动时需要发起对网络中其他节点的连接请求，因此需要配置其他节点的连接信息（IP/域名，p2pport），因为此时网络并无其他节点，因此配置为节点自身即可，可以拷贝默认bootstrapnodes.json文件即可。 建议此处的IP配置为节点所在的真实IP。）
- 节点身份证书文件：2.5 证书说明所列文件

==如何动态添加/删除修改节点？==

**智能合约**

部署在区块链上的应用，使用solidity语言开发，fisco-solc编译。

需要设置区块链节点RPC端口（Remote Procedure Call，远程过程调用，一种允许分布式应用程序调用网络上不同计算机的可用服务的机制）

**系统接口的调用方法**

必须采用FISCO-BCOS github上发布SDK和工具，目前已经有java版(源自web3j)和nodejs版，

- ==web3调用方法== 一个Java SDK to communicate with FISCO BCOS （[Github: web3sdk](https://github.com/FISCO-BCOS/web3sdk) ）
- 工具使用方法 `babel-node tool.js` + `接口名称`

**系统合约**

FISCO-BCOS内置的智能合约，原则上只允许管理员账号调用，主要用于管理区块链网络。每条区块链仅需部署一次系统合约（在创世节点上部署）

系统合约包括：系统代理合约，节点管理合约，注销证书合约、权限管理合约、全网配置合约。

参考12.6 系统合约

==理论上是可以在普通节点上调用的，要搞清楚外部账号是如何使用的，可以在普通节点上登陆管理员账号么？==

**系统代理合约**

是系统合约的统一入口，通过在每一个节点上配置系统代理合约地址（`systemproxyaddress`），才能正确地调用系统合约。

注意，`systemproxyaddress`就是在创世节点上配置系统合约时输出的`SystemProxyContact address`，无论是创世节点，还是普通节点，都需要配置这个参数，这样我们在调用系统合约时，才能够找到正确的入口。

源码路径：`systemcontract/SystemProxy.sol`

**系统代理合约-节点管理合约**

源码路径：`systemcontract/NodeAction.sol`

维护网络中节点列表（节点的加入和退出）

**系统代理合约-权限管理合约**

源码路径：`systemcontract/AuthorityFilter.sol`

区块链权限模型的实现。

一个外部账户只属于一个角色，一个角色拥有一个权限列表

一个权限项由合约地址加合约接口来唯一标识 ==通过限制哪些合约可以使用来限制权限？==

==如何设计权限列表？==

**创建普通节点**

一条区块链网络中，除了一个创世节点外，其他都是普通节点。

同一条链中的所有节点都共用相同的创世块文件`genesis.json`（因为只有一个创世节点），并且节点所属机构必须都是由同一个链证书所签发的。

- 连接文件`bootstrapnodes.json`：填入创世节点的IP和p2pport
- 配置文件`genesis.json, config.json, log.conf`
- 节点证书身份文件

节点配置好、启动后，还需要注册到区块链中，参考*第七章 多节点组网*

**多记账节点组网**

FISCO-BCOS中的节点，只有被注册到系统合约记账节点列表（`systemcontract`）中，才能参与记账。

使用节点管理合约（`systemcontract/NodeAction.sol`）进行节点的注册和退出。

注册步骤：启动所有待注册的节点；在创世节点的`systemcontract`目录下运行脚本`babel-node tool.js NodeAction register 节点注册文件node.json的路径`注册节点。

==节点原则上应该可以部署在不同机器上，那么在部署时是先拷贝FISCO-BCOS源码，然后按照普通节点部署方法部署吗？如果是这样，远程节点在注册时，node.json路径怎么填写？`host/path`?==

退出节点：`babel-node tool.js NodeAction cancel 节点的注册文件node.json路径`

**证书注销**

FISCO-BCOS区块链中的管理者可以通过登记证书到注销证书列表，来禁止使用该证书的节点接入网络。（调用注销证书合约`systemcontract/CAAction`）

`babel-node tool.js CAAction add 节点证书路径`

**使用控制台**

控制台能够以IPC（进程间通信）的方式直接连接区块链节点进程。

==可以使用控制台操作远程机器么？==

#### 文章：[揭秘FISCO BCOS安全架构](https://github.com/FISCO-BCOS/Wiki/blob/master/FISCO%20BCOS%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84%E3%80%90RUN%E8%B5%8B%E8%83%BD%E8%AE%A1%E5%88%92%E3%80%91%E7%AC%AC%E4%B8%80%E6%9C%9F/FISCO%20BCOS%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84%E3%80%90RUN%E8%B5%8B%E8%83%BD%E8%AE%A1%E5%88%92%E3%80%91%E7%AC%AC%E4%B8%80%E6%9C%9F.md)

**摘要**：

**控制**：

FISCO-BCOS出块节点注册机制：在系统合约里提供了管理记账节点的工具，仅将节点注册到记账者列表，节点才可作为leader出块；若节点不可信，可调用该工具将其从记账者列表中移除；

**脱敏**：

高度敏感的数据，转换成伪码上链或者考虑不上链。也可以是用hash摘要或者少量元数据的方式上链。

**加密**：

支持对称加密、非对称加密算法、密码信封等等，以及零知识证明，群签名，环签名、阈值签名等，重点是支持国密。

**隔离**：

不把数据发给交易不相干的人。即使密码破译能力到了能够解开这些加密数据的时候了，因为严格的隔离措施，依旧能够确保数据的安全。

==这些加密算法如何使用？==

## EOS

EOS 是由BM（Daniel Larimer）领导开发的区块链应用平台，==目前测试网络尚未发布？==。其slogan是“去中心化一切”，旨在为区块链提供更高的性能。

==EOS公链？==

[EOS GitHub](https://github.com/EOSIO/eos)

[EOS Document](https://github.com/EOSIO/Documentation/blob/master/TechnicalWhitePaper.md)

[EOS区块链开发指南](http://blog.eosdata.io/index.php/tag/eos/)